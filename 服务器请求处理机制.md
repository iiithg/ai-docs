# 服务器请求处理机制：三步走完一次完整的交互

很多人搞不懂服务器是怎么处理请求的。其实逻辑非常简单，就三个步骤。搞懂这三个步骤，你就能理解整个网络通信的本质。

## 第一步：解析并执行

服务器收到请求的第一件事，就是拆包。

它不是直接干活，而是先解析。解析什么？解析HTU@头、解析请求体、解析参数。这些信息打包过来了，服务器得拆开看清楚你到底要什么。

拆完了就扥行。扥行什么？数据库查询、文件读取、业务逻辑计算。这些都是后端的硬活。

比如你点了一个查询按钮，服务器收到请求，解析出来你要查用户信息。然后它去数据库里跑一次查询，把数据捞出来。这一步是整个流程的核心，也是最容易出问题的地方。

代码写得烂，这里就会慢；数据库建得差，这里就会卡。所以很多时候优化服务器，本质上就是优化这一步。

## 第二步：封装并返回

数据拿到了，不能直接扔给客户端。得包装一下。

服务器把处理结果封装成HTTP响应。头部加状态码，告诉你是成功了还是失败了；头部加Content-Type，告诉返回的是什么格式；再把真正的数据塞进响应体。

然后发回去。

这个发回去的过程，就像快递发货。你把东西包好了，写上地址，交给快递员。快递员送到了，客户收到快递，拆开看里面的东西。

服务器就是那个发货的人，客户端就是收货的人。中间经过了网络传输，经过了各种路由器、防火墙。但本质上，就是这么简单的发收关系。

## 第三步：断开连接

事情做完了，该断开了。

TCP连接是宝贵的资源，不能一直占着。客户端可以主动关，服务器也可以超时关。

怎么关？四次挥手。客户端告诉服务器我发完了，服务器确认。服务器告诉客户端我也发完了，客户端确认。连接就这么干净利落地断开了。

如果客户端忘了关怎么办？服务器会设个超时时间。时间到了，直接强制断开。

这个设计很聪明。既保证了及时释放资源，又防止了连接泄漏。每个连接都是有成本的，内存、CP、文件描述符，都是钱。

## 总结

服务器处理请求，就这三个动作。

解析执行，封装返回，断开连接。每一步都有它的道理，每一步都不能少。

理解了这个，你就理解了Web服务器。理解了Web服务器，你就能写出更好的后端代码，能更快地定位问题，能做出更合理的架构设计。

这就是技术底层逻辑的力量。搞懂了原理，一切变得简单。
